---

- name: Test pyenv and Python Installation
  hosts: all

  vars:
    python_version: 2.7.13
    python_modules:
      - ansible
      - pytest

  pre_tasks:
    - name: Update apt
      become: yes
      apt:
        update_cache: yes
        cache_valid_time: 3600
      tags:
        - build

  roles:
    - role: sansible.pyenv
      sansible_pyenv:
        activate: no
        python_version: system
      tags:
        - build

    - role: sansible.pyenv
      sansible_pyenv:
        activate: no
        python_version: "{{ python_version }}"
        python_modules: "{{ python_modules }}"

    - role: sansible.pyenv
      sansible_pyenv:
        activate: yes
        python_version: "{{ python_version }}"

  post_tasks:
    - name: Check if Python Version has been installed
      become: yes
      command: bash -lc "pyenv versions --bare --skip-aliases"
      changed_when: no
      register: pyenv_versions_list
      failed_when: python_version not in  pyenv_versions_list.stdout
      tags:
        - assert

    - name: Check if Python Modules have been installed
      become: yes
      pip:
        executable: "~/.pyenv/versions/{{ python_version }}/bin/pip"
        name: "{{ item }}"
      with_items: "{{ python_modules }}"
      tags:
        - assert

    - name: Check if correct version of Python is activated
      become: yes
      command: bash -lc "pyenv global"
      register: python_version_check
      changed_when: no
      failed_when: python_version_check.stdout != python_version
      tags:
        - assert
